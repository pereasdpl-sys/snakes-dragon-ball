<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dragon Snake DBZ - Ranking</title>
<style>
:root { --cell: 30px; }
body { margin:0; background:#000; color:#fff; font-family:"Segoe UI",sans-serif; display:flex; flex-direction:column; align-items:center; gap:8px; padding:10px; overflow:hidden;}
h1 { color:gold; text-shadow:0 0 12px orange; margin:0; }
#topbar { display:flex; gap:10px; align-items:center; width:100%; max-width:600px; }
#user { font-size:14px; color:#ffd; }
#score { color:#ffcc00; text-shadow:0 0 8px #a00; margin-left:auto; }
button { padding:8px 14px; border-radius:8px; border:none; background:gold; color:#000; font-weight:600; cursor:pointer; }
#gameCanvas { border:3px solid gold; border-radius:10px; box-shadow:0 0 25px gold; width:600px; height:600px; display:block; background-image:url('https://i.imgur.com/q4p6g8p.jpg'); background-size:cover; background-position:center; }
#overlay { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.85); color:gold; padding:24px 32px; border-radius:12px; font-weight:700; display:none; text-align:center; box-shadow:0 0 40px rgba(255,215,0,0.6); font-size:20px;}
#ranking { max-width:600px; width:100%; margin-top:12px; border:2px solid gold; border-radius:12px; padding:8px; background:rgba(0,0,0,0.5); }
#ranking h2 { margin:4px 0; color:#ffd700; text-align:center; }
#ranking ul { list-style:none; padding:0; margin:0; }
#ranking li { margin:2px 0; }
@media(max-width:640px){ #gameCanvas{width:90vw;height:90vw;} }
</style>
</head>
<body>
<h1>Dragon Snake DBZ</h1>
<div id="topbar">
  <div id="user">No has iniciado sesión</div>
  <button id="loginBtn">Iniciar sesión con Google</button>
  <div id="score">Puntuación: 0 | Bolas: 0 | Nivel: 1</div>
</div>
<canvas id="gameCanvas" width="600" height="600"></canvas>
<div style="margin-top:6px">
  <button id="startBtn">Iniciar</button>
  <button id="pauseBtn">Pausa</button>
  <button id="restartBtn" style="display:none">Reiniciar</button>
</div>
<div id="overlay"></div>
<div id="ranking">
  <h2>Ranking</h2>
  <ul id="rankingList"><li>Cargando...</li></ul>
</div>

<audio id="eatSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
<audio id="teleportSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
// Variables
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const startBtn = document.getElementById('startBtn');
const pauseBtn = document.getElementById('pauseBtn');
const restartBtn = document.getElementById('restartBtn');
const overlay = document.getElementById('overlay');
const eatSound = document.getElementById('eatSound');
const teleportSound = document.getElementById('teleportSound');

let CELL = 30, COLS = Math.floor(canvas.width / CELL), ROWS = Math.floor(canvas.height / CELL);
let snake=[], dir={x:1,y:0}, nextDir=null, foodList=[], score=0;
let running=false, paused=false, gameInterval=null, level=1, particles=[];

// Inicializar juego
function resetGame(){
  snake = [];
  const sx = Math.floor(COLS/2), sy = Math.floor(ROWS/2);
  for(let i=0;i<4;i++) snake.push({x:sx-i,y:sy});
  dir={x:1,y:0}; nextDir=null;
  score=0; level=1;
  spawnFood();
  updateUI();
  draw();
}

// Generar bolas
function spawnFood(){
  foodList=[];
  const balls = level===1 ? 7 : 5;
  for(let i=0;i<balls;i++) spawnSingleFood();
}
function spawnSingleFood(){
  let fx, fy;
  do{
    fx=Math.floor(Math.random()*COLS);
    fy=Math.floor(Math.random()*ROWS);
  }while(snake.some(s=>s.x===fx&&s.y===fy)||foodList.some(f=>f.x===fx&&f.y===fy));
  foodList.push({x:fx,y:fy});
}

// Control
document.addEventListener('keydown', e=>{
  if(!running) return;
  if((e.key==='ArrowUp'||e.key==='w')&&dir.y!==1) nextDir={x:0,y:-1};
  if((e.key==='ArrowDown'||e.key==='s')&&dir.y!==-1) nextDir={x:0,y:1};
  if((e.key==='ArrowLeft'||e.key==='a')&&dir.x!==1) nextDir={x:-1,y:0};
  if((e.key==='ArrowRight'||e.key==='d')&&dir.x!==-1) nextDir={x:1,y:0};
});

// Partículas
function createParticles(x,y,count=20){
  for(let i=0;i<count;i++){
    particles.push({
      x, y,
      dx:(Math.random()-0.5)*4,
      dy:(Math.random()-0.5)*4,
      alpha:1,
      size:3
    });
  }
}

// Lógica del juego
function gameTick(){
  if(nextDir){ dir=nextDir; nextDir=null; }
  const head={x:snake[0].x+dir.x,y:snake[0].y+dir.y};
  if(head.x<0||head.x>=COLS||head.y<0||head.y>=ROWS || snake.some((s,i)=>i>0&&s.x===head.x&&s.y===head.y)) return endGame();
  snake.unshift(head);

  let ate=false;
  for(let i=0;i<foodList.length;i++){
    const f=foodList[i];
    if(f.x===head.x && f.y===head.y){
      score+=10;
      eatSound.currentTime=0; eatSound.play();
      foodList.splice(i,1);
      ate=true;
      spawnSingleFood();
      createParticles(f.x*CELL+CELL/2,f.y*CELL+CELL/2);
      break;
    }
  }
  if(!ate) snake.pop();
  updateUI();

  if(level===1 && foodList.length===0){
    startTransition();
  }
}

// Transición nivel 1
function startTransition(){
  showOverlay("¡Has reunido las 7 Bolas del Dragón!\nShenlong te teletransporta...",3000);
  teleportSound.currentTime=0; teleportSound.play();
  createParticles(canvas.width/2,canvas.height/2,50);
  setTimeout(()=>{
    teleportToCenter();
    level=2;
    spawnFood();
  },3000);
}

function teleportToCenter(){
  const hx=Math.floor(COLS/2), hy=Math.floor(ROWS/2), dx=hx-snake[0].x, dy=hy-snake[0].y;
  for(let i=0;i<snake.length;i++){ snake[i].x+=dx; snake[i].y+=dy; }
}

// UI
function updateUI(){ scoreEl.textContent=`Puntuación: ${score} | Bolas: ${foodList.length} | Nivel: ${level}`; }
function showOverlay(text,ms=1500){ overlay.style.display='block'; overlay.innerText=text; setTimeout(()=>{ overlay.style.display='none'; },ms); }

// Game over
function endGame(){ running=false; clearInterval(gameInterval); showOverlay(`¡Has muerto!\nPuntuación: ${score}`,3000); restartBtn.style.display='inline-block'; }

// Dibujar
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // cuadrícula
  ctx.strokeStyle='rgba(255,255,255,0.08)';
  for(let x=0;x<=COLS;x++){ ctx.beginPath(); ctx.moveTo(x*CELL,0); ctx.lineTo(x*CELL,canvas.height); ctx.stroke(); }
  for(let y=0;y<=ROWS;y++){ ctx.beginPath(); ctx.moveTo(0,y*CELL); ctx.lineTo(canvas.width,y*CELL); ctx.stroke(); }

  // bolas
  for(const f of foodList){
    const cx=f.x*CELL+CELL/2, cy=f.y*CELL+CELL/2;
    ctx.fillStyle='orange';
    ctx.beginPath(); ctx.arc(cx,cy,CELL*0.35,0,2*Math.PI); ctx.fill();
  }

  // dragón
  if(snake.length>0){
    ctx.fillStyle='limegreen';
    for(let i=0;i<snake.length;i++){
      const p=snake[i];
      ctx.fillRect(p.x*CELL+2,p.y*CELL+2,CELL-4,CELL-4);
    }
  }

  // partículas
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    ctx.fillStyle=`rgba(255,215,0,${p.alpha})`;
    ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,2*Math.PI); ctx.fill();
    p.x+=p.dx; p.y+=p.dy; p.alpha-=0.03;
    if(p.alpha<=0) particles.splice(i,1);
  }

  if(!running){
    ctx.fillStyle='rgba(0,0,0,0.5)';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='gold';
    ctx.font=`${Math.max(16,Math.floor(canvas.width/20))}px Arial`;
    ctx.textAlign='center';
    ctx.fillText('Pulsa INICIAR',canvas.width/2,canvas.height/2);
  }
  requestAnimationFrame(draw);
}

// Botones
startBtn.addEventListener('click', ()=>{
  resetGame(); running=true; startBtn.style.display='none'; pauseBtn.style.display='inline-block';
  if(gameInterval) clearInterval(gameInterval);
  gameInterval=setInterval(()=>{if(running&&!paused) gameTick();},1000/7);
});
pauseBtn.addEventListener('click',()=>{ if(!running) return; paused=!paused; pauseBtn.textContent=paused?'Reanudar':'Pausa'; });
restartBtn.addEventListener('click',()=>{ resetGame(); running=true; restartBtn.style.display='none'; if(gameInterval) clearInterval(gameInterval); gameInterval=setInterval(()=>{if(running&&!paused) gameTick();},1000/7); });

resetGame(); draw();
</script>
</body>
</html>
